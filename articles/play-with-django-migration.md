---
title: Play with Django migration
date: "2019-11-28"
tags: Django, migration
---

In this post, I will show you a little magic of Django migration by resolving a weird issue.

<!-- more -->
# Steps to reproduce

1. Create a Django project

```bash
django-admin startproject mysite
```

2. Create a Django app

```bash
cd mysite
python manage.py startapp polls
```

3. Declare a table model

```python
from django.db import models
from django.db.models import Model
# Create your models here.


class TestTable(Model):
    class Meta:
        db_table = 'test_table'

    id = models.AutoField(primary_key=True)
    col1 = models.TextField(null=True)
    col2 = models.TextField(null=True)
```

4. Create migration and do migrate

```bash
python manage.py makemigrations
```

as result:
```
# Generated by Django 2.1.5 on 2019-11-28 15:42

from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='TestTable',
            fields=[
                ('id', models.AutoField(primary_key=True, serialize=False)),
                ('col1', models.TextField(null=True)),
                ('col2', models.TextField(null=True)),
            ],
            options={
                'db_table': 'test_table',
            },
        ),
    ]
```

apply the migration:
```bash
python manage.py migrate
```

5. Modify the model, rename the column

After renaming `col1` column to `name` column. The new migration file will be created:
```python
# Generated by Django 2.1.5 on 2019-11-28 15:47

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('polls', '0001_initial'),
    ]

    operations = [
        migrations.RenameField(
            model_name='testtable',
            old_name='col1',
            new_name='name',
        ),
    ]
```
But, to make the issue happen, we need to use `RunSQL` instead. So we will change like below:
```python
# Generated by Django 2.1.5 on 2019-11-28 15:47
from django.db import migrations
class Migration(migrations.Migration):
    dependencies = [
        ('polls', '0001_initial'),
    ]
    operations = [
        migrations.RunSQL("ALTER TABLE test_table RENAME COLUMN col1 TO name"),
        ]
```

7. Modify the model, and new column

Now, we modify the model to add a new column. and trying advanced migration with `RunPython`
The first thing to see here is `Django` doesn't realize that I renamed the column. In newly generated migration, it produces some statements to remove column `col1` and add `name` column again. That means when creating a migration, `Django` doesn't look at the current model declaration only, but also it looks at all migrations. Then maybe simulate all migrations to create the latest model definition, and lastly, compare with the database.

And, the thing is, `RunSQL` weren't be included in that process, or it was but it's hard to represent its changes to the model definition. That causes the wrong migration created.

At this step, I use `RunPython` to do some data migration first, as below:
```python
# Generated by Django 2.1.5 on 2019-11-28 16:32
from django.apps.registry import Apps
from django.db import migrations, models


def migrate_data(apps: Apps, schema_editor):
    TestTable = apps.get_model("polls", "TestTable")
    all_data = TestTable.objects.all()
    for data in all_data:
        data.email = data.name

class Migration(migrations.Migration):

    dependencies = [
        ('polls', '0002_auto_20191128_1547'),
    ]

    operations = [
        migrations.RunPython(migrate_data),
    ]
```

And if I run `python manage.py migrate` now, I will get an error about missing `col` column even if I didn't touch on it.

```bash
django.db.utils.ProgrammingError: column test_table.col1 does not exist
LINE 1: SELECT "test_table"."id", "test_table"."col1", "test_table"....
```

The problem was told before, the `col1` still exists in the model definition.

